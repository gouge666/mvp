<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å™¨æ–‡ä»¶ä¼ è¾“æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        select, input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-name.directory {
            color: #667eea;
        }
        
        .file-name.hidden {
            opacity: 0.7;
        }
        
        .file-details {
            font-size: 12px;
            color: #666;
        }
        
        .file-type {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .file-type.directory {
            background: #e7f3ff;
            color: #0066cc;
        }
        
        .file-type.file {
            background: #f0f0f0;
            color: #666;
        }
        
        .file-type.link {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .path-breadcrumb {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-family: monospace;
            color: #667eea;
            font-weight: 500;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æœåŠ¡å™¨æ–‡ä»¶ä¼ è¾“æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">Server103 - æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢ä¸ä¼ è¾“æµ‹è¯•</p>
        
        <!-- æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢ -->
        <div class="section">
            <h2>ğŸ“ æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢</h2>
            <div class="form-group">
                <label for="server-select">é€‰æ‹©æœåŠ¡å™¨:</label>
                <select id="server-select">
                    <option value="server101">Server101 (192.168.140.201)</option>
                    <option value="server102">Server102 (192.168.140.202)</option>
                    <option value="server103" selected>Server103 (192.168.140.203)</option>
                    <option value="server104">Server104 (192.168.140.204)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="path-input">è·¯å¾„:</label>
                <input type="text" id="path-input" value="/home/user" placeholder="ä¾‹å¦‚: /home/user">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="listFiles()">æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨</button>
                <button class="btn-secondary" onclick="goToParent()">è¿”å›ä¸Šçº§ç›®å½•</button>
            </div>
            
            <!-- åœ¨å½“å‰è·¯å¾„åˆ›å»ºæ–°æ–‡ä»¶ -->
            <div class="form-group" style="margin-top: 20px;">
                <label for="new-file-name">åœ¨å½“å‰è·¯å¾„åˆ›å»ºæ–°æ–‡ä»¶ - æ–‡ä»¶å:</label>
                <input type="text" id="new-file-name" placeholder="ä¾‹å¦‚: new_file.txt">
            </div>
            <div class="form-group">
                <label for="new-file-content">æ–‡ä»¶å†…å®¹:</label>
                <textarea id="new-file-content" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ–‡ä»¶å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œæ–‡æœ¬ï¼‰"></textarea>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="createFileInCurrentPath()">åœ¨å½“å‰è·¯å¾„åˆ›å»ºæ–‡ä»¶</button>
            </div>
            <div class="loading" id="loading">åŠ è½½ä¸­...</div>
            <div class="result" id="result"></div>
            <div class="path-breadcrumb" id="current-path" style="display:none;">å½“å‰è·¯å¾„: <span id="path-display"></span></div>
            <div class="file-list" id="file-list"></div>
        </div>

        <!-- ç”¨æˆ·åˆå§‹åŒ– -->
        <div class="section">
            <h2>ğŸ‘¤ ç”¨æˆ·åˆå§‹åŒ–ï¼ˆåœ¨å››å°æœåŠ¡å™¨åˆ›å»ºç›®å½•ï¼‰</h2>
            <div class="form-group">
                <label for="init-username">ç”¨æˆ·å (å¦‚: gousk):</label>
                <input type="text" id="init-username" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œå¦‚: gousk" required>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="createUserOnAllServers()">åˆ›å»ºç”¨æˆ·åŸºç¡€ç›®å½•</button>
            </div>
            <div class="result" id="init-user-result"></div>
        </div>
        
        <!-- æ–‡ä»¶ä¼ è¾“æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ“¤ æ–‡ä»¶ä¼ è¾“æµ‹è¯•</h2>
            <div class="form-group">
                <label for="transfer-username">ç”¨æˆ·å (å¦‚: gousk):</label>
                <input type="text" id="transfer-username" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œå¦‚: gousk" required>
            </div>
            <div class="form-group">
                <label for="transfer-project">é¡¹ç›®åç§°:</label>
                <input type="text" id="transfer-project" placeholder="é¡¹ç›®åç§°">
            </div>
            <div class="form-group">
                <label for="transfer-target">ç›®æ ‡æœåŠ¡å™¨:</label>
                <select id="transfer-target">
                    <option value="server101">Server101</option>
                    <option value="server102">Server102</option>
                    <option value="server103">Server103</option>
                    <option value="server104">Server104</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="transferFolder()">å¼€å§‹ä¼ è¾“</button>
            </div>
            <div class="result" id="transfer-result"></div>
        </div>
        
        <!-- å¤šæ–‡ä»¶/ç›®å½•ä¼ è¾“ -->
        <div class="section">
            <h2>ğŸ“¦ å¤šæ–‡ä»¶/ç›®å½•ä¼ è¾“</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                æ”¯æŒä»ä»»æ„æœåŠ¡å™¨é€‰æ‹©å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼Œä¼ è¾“åˆ°ä»»æ„æœåŠ¡å™¨çš„æŒ‡å®šç›®å½•ã€‚å¦‚æœç›®æ ‡ç›®å½•å­˜åœ¨ï¼Œä¼šå…ˆæ¸…ç©ºå…¶å†…å®¹ã€‚
            </p>
            <div class="form-group">
                <label for="multi-source-server">æºæœåŠ¡å™¨:</label>
                <select id="multi-source-server">
                    <option value="server101">Server101 (192.168.140.201)</option>
                    <option value="server102">Server102 (192.168.140.202)</option>
                    <option value="server103">Server103 (192.168.140.203)</option>
                    <option value="server104">Server104 (192.168.140.204)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="multi-source-paths">æºè·¯å¾„åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªè·¯å¾„ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶æˆ–ç›®å½•ï¼‰:</label>
                <textarea id="multi-source-paths" placeholder="/home/user/gousk/projects/project1&#10;/home/user/gousk/projects/file1.txt&#10;/home/user/gousk/projects/dir1" style="min-height: 120px; font-family: monospace;"></textarea>
                <small style="color: #666; display: block; margin-top: 5px;">æç¤ºï¼šæ¯è¡Œè¾“å…¥ä¸€ä¸ªå®Œæ•´è·¯å¾„ï¼Œæ”¯æŒæ–‡ä»¶å’Œç›®å½•æ··åˆ</small>
            </div>
            <div class="form-group">
                <label for="multi-target-server">ç›®æ ‡æœåŠ¡å™¨:</label>
                <select id="multi-target-server">
                    <option value="server101">Server101 (192.168.140.201)</option>
                    <option value="server102">Server102 (192.168.140.202)</option>
                    <option value="server103">Server103 (192.168.140.203)</option>
                    <option value="server104">Server104 (192.168.140.204)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="multi-target-path">ç›®æ ‡ç›®å½•è·¯å¾„:</label>
                <input type="text" id="multi-target-path" placeholder="/home/user/gousk/tasks" style="font-family: monospace;">
                <small style="color: #666; display: block; margin-top: 5px;">æç¤ºï¼šå¦‚æœç›®å½•å­˜åœ¨ä¼šå…ˆæ¸…ç©ºï¼Œä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</small>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="transferMultiple()">å¼€å§‹å¤šæ–‡ä»¶ä¼ è¾“</button>
                <button class="btn-secondary" onclick="clearMultiTransferResult()">æ¸…ç©ºç»“æœ</button>
            </div>
            <div class="result" id="multi-transfer-result"></div>
            <div id="multi-transfer-details" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <!-- è™šæ‹Ÿç¯å¢ƒç®¡ç† -->
        <div class="section">
            <h2>ğŸ è™šæ‹Ÿç¯å¢ƒç®¡ç† (Server102)</h2>
            <div class="form-group">
                <label for="venv-username">ç”¨æˆ·å (å¦‚: gousk):</label>
                <input type="text" id="venv-username" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œå¦‚: gousk" required>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="loadEnvs()">åˆ·æ–°ç¯å¢ƒåˆ—è¡¨</button>
            </div>
            <div class="result" id="venv-result"></div>
            <div id="env-list" style="margin-top: 15px;"></div>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">åˆ›å»ºæ–°ç¯å¢ƒ</h3>
            <div class="form-group">
                <label for="new-env-name">ç¯å¢ƒåç§°:</label>
                <input type="text" id="new-env-name" placeholder="ä¾‹å¦‚: myenv">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="createEnv()">åˆ›å»ºç¯å¢ƒ</button>
            </div>
        </div>
        
        <!-- ç®—æ³•æ‰§è¡Œ -->
        <div class="section">
            <h2>ğŸš€ ç®—æ³•æ‰§è¡Œ</h2>
            <div class="form-group">
                <label for="execute-username">ç”¨æˆ·å:</label>
                <input type="text" id="execute-username" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œå¦‚: gousk" required>
            </div>
            <div class="form-group">
                <label for="execute-server">æ‰§è¡ŒæœåŠ¡å™¨:</label>
                <select id="execute-server">
                    <option value="server102" selected>Server102 (ç¯å¢ƒç®¡ç†æœåŠ¡å™¨)</option>
                    <option value="server101">Server101</option>
                    <option value="server103">Server103</option>
                    <option value="server104">Server104</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="loadProjects()">åˆ·æ–°é¡¹ç›®åˆ—è¡¨</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label for="execute-project">é€‰æ‹©é¡¹ç›®:</label>
                <select id="execute-project">
                    <option value="">è¯·å…ˆåˆ·æ–°é¡¹ç›®åˆ—è¡¨</option>
                </select>
            </div>
            <div class="form-group">
                <label for="execute-env">é€‰æ‹©è™šæ‹Ÿç¯å¢ƒ (å¿…éœ€):</label>
                <select id="execute-env" required>
                    <option value="">è¯·å…ˆåˆ·æ–°ç¯å¢ƒåˆ—è¡¨</option>
                </select>
            </div>
            <div class="form-group">
                <label for="execute-command">æ‰§è¡Œå‘½ä»¤:</label>
                <input type="text" id="execute-command" placeholder="ä¾‹å¦‚: python main.py æˆ– python train.py" style="font-family: monospace;" required>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="executeProject()">æ‰§è¡Œç®—æ³•</button>
                <button class="btn-primary" onclick="executeProjectBackground()" style="background: #28a745;">åå°æ‰§è¡Œï¼ˆè¿”å›PIDï¼‰</button>
                <button class="btn-secondary" onclick="clearExecuteOutput()">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div class="result" id="execute-result"></div>
            <div id="execute-output" style="margin-top: 15px; padding: 15px; background: #1e1e1e; color: #d4d4d4; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; display: none;"></div>
        </div>
        
        <!-- ç½‘é¡µç»ˆç«¯ -->
        <div class="section">
            <h2>ğŸ’» ç½‘é¡µç»ˆç«¯</h2>
            <div class="form-group">
                <label for="terminal-env">é€‰æ‹©ç¯å¢ƒï¼ˆå¯é€‰ï¼‰:</label>
                <select id="terminal-env">
                    <option value="">ä¸ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="terminal-command">å‘½ä»¤:</label>
                <input type="text" id="terminal-command" placeholder="ä¾‹å¦‚: pip install -r requirements.txt --index-url http://localhost:8087/simple/ --trusted-host localhost" style="font-family: monospace;">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="executeCommand()">æ‰§è¡Œå‘½ä»¤</button>
                <button class="btn-secondary" onclick="clearTerminal()">æ¸…ç©ºè¾“å‡º</button>
            </div>
            <div id="terminal-output" style="margin-top: 15px; padding: 15px; background: #1e1e1e; color: #d4d4d4; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></div>
        </div>
        
        <!-- ä»»åŠ¡æ£€æŸ¥ä¸å¤åˆ¶ -->
        <div class="section">
            <h2>ğŸ“‹ ä»»åŠ¡æ£€æŸ¥ä¸å¤åˆ¶</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                æ£€æŸ¥10.2æœåŠ¡å™¨ä¸Šçš„è¿›ç¨‹çŠ¶æ€ï¼Œå¦‚æœå·²å®Œæˆåˆ™æ£€æŸ¥å¹¶å¤åˆ¶è¾“å‡ºç›®å½•å’Œæ—¥å¿—æ–‡ä»¶åˆ°10.4æœåŠ¡å™¨
            </p>
            <div class="form-group">
                <label for="task-username">ç”¨æˆ·å:</label>
                <input type="text" id="task-username" value="" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼Œå¦‚: gousk" required>
            </div>
            <div class="form-group">
                <label for="task-pid">è¿›ç¨‹ID (PID):</label>
                <input type="text" id="task-pid" placeholder="ä¾‹å¦‚: 12345" required>
            </div>
            <div class="form-group">
                <label for="task-projectname">ç®—æ³•é¡¹ç›®å:</label>
                <input type="text" id="task-projectname" placeholder="ä¾‹å¦‚: myalgorithm" required>
            </div>
            <div class="form-group">
                <label for="task-taskid">ä»»åŠ¡ID:</label>
                <input type="text" id="task-taskid" placeholder="ä¾‹å¦‚: task001" required>
            </div>
            <div class="form-group">
                <label for="task-log-file">æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨æŸ¥æ‰¾ï¼‰:</label>
                <input type="text" id="task-log-file" placeholder="ä¾‹å¦‚: /tmp/myalgorithm_12345.log" style="font-family: monospace;">
                <small style="color: #666; display: block; margin-top: 5px;">æç¤ºï¼šå¦‚æœä¸æä¾›ï¼Œç³»ç»Ÿä¼šæ ¹æ®é¡¹ç›®åå’ŒPIDè‡ªåŠ¨æŸ¥æ‰¾ï¼š/tmp/{é¡¹ç›®å}_{PID}.log</small>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="checkTaskAndCopy()">æ£€æŸ¥å¹¶å¤åˆ¶</button>
                <button class="btn-secondary" onclick="clearTaskResult()">æ¸…ç©ºç»“æœ</button>
            </div>
            <div class="result" id="task-result"></div>
        </div>
        
        <!-- æ–‡ä»¶å†…å®¹è¯»å– -->
        <div class="section">
            <h2>ğŸ“– æ–‡ä»¶å†…å®¹è¯»å–</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                è¯»å–æŒ‡å®šæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å†…å®¹ï¼Œä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›
            </p>
            <div class="form-group">
                <label for="read-server">é€‰æ‹©æœåŠ¡å™¨:</label>
                <select id="read-server">
                    <option value="server101">Server101 (192.168.140.201)</option>
                    <option value="server102">Server102 (192.168.140.202)</option>
                    <option value="server103" selected>Server103 (192.168.140.203)</option>
                    <option value="server104">Server104 (192.168.140.204)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="read-file-path">æ–‡ä»¶è·¯å¾„:</label>
                <input type="text" id="read-file-path" placeholder="ä¾‹å¦‚: /home/user/test.txt" style="font-family: monospace;">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="readFileContent()">è¯»å–æ–‡ä»¶</button>
                <button class="btn-secondary" onclick="clearFileContent()">æ¸…ç©ºå†…å®¹</button>
            </div>
            <div class="result" id="read-file-result"></div>
            <div id="file-content-display" style="margin-top: 15px; padding: 15px; background: #1e1e1e; color: #d4d4d4; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; display: none;"></div>
        </div>
    </div>
    
    <script>
        let currentPath = '/home/user';
        let currentServer = 'server103';
        
        function showResult(elementId, message, isSuccess) {
            const resultDiv = document.getElementById(elementId);
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦
            const escapedMessage = String(message).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>').replace(/\r/g, '');
            resultDiv.innerHTML = escapedMessage;
            resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultDiv.style.display = 'block';
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        async function listFiles() {
            const server = document.getElementById('server-select').value;
            const path = document.getElementById('path-input').value || '/home/user';
            
            currentPath = path;
            currentServer = server;
            
            showLoading(true);
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('result').style.display = 'none';
            
            try {
                const response = await fetch('/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        server: server,
                        path: path
                    })
                });
                
                const data = await response.json();
                showLoading(false);
                
                if (data.success) {
                    document.getElementById('current-path').style.display = 'block';
                    document.getElementById('path-display').textContent = data.path;
                    displayFiles(data.files);
                    showResult('result', `æˆåŠŸæŸ¥è¯¢åˆ° ${data.count} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`, true);
                } else {
                    showResult('result', `é”™è¯¯: ${data.error}`, false);
                }
            } catch (error) {
                showLoading(false);
                showResult('result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function displayFiles(files) {
            const fileListDiv = document.getElementById('file-list');
            fileListDiv.innerHTML = '';
            
            if (files.length === 0) {
                fileListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ç›®å½•ä¸ºç©º</div>';
                return;
            }
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name ' + file.type + (file.is_hidden ? ' hidden' : '');
                fileName.textContent = file.name;
                if (file.type === 'directory') {
                    fileName.style.cursor = 'pointer';
                    fileName.onclick = () => {
                        document.getElementById('path-input').value = file.full_path;
                        listFiles();
                    };
                }
                
                const fileDetails = document.createElement('div');
                fileDetails.className = 'file-details';
                fileDetails.textContent = `${file.permissions} | ${file.owner}:${file.group} | ${file.size} | ${file.date}`;
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileDetails);
                
                const fileType = document.createElement('div');
                fileType.className = 'file-type ' + file.type;
                fileType.textContent = file.type === 'directory' ? 'ğŸ“ ç›®å½•' : (file.type === 'link' ? 'ğŸ”— é“¾æ¥' : 'ğŸ“„ æ–‡ä»¶');
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(fileType);
                fileListDiv.appendChild(fileItem);
            });
        }
        
        function goToParent() {
            const path = currentPath;
            const parentPath = path.split('/').slice(0, -1).join('/') || '/';
            document.getElementById('path-input').value = parentPath;
            listFiles();
        }
        
        // åœ¨å½“å‰è·¯å¾„åˆ›å»ºæ–‡ä»¶
        async function createFileInCurrentPath() {
            const server = document.getElementById('server-select').value;
            const path = document.getElementById('path-input').value || '/home/user';
            const filename = document.getElementById('new-file-name').value.trim();
            const content = document.getElementById('new-file-content').value;

            if (!filename) {
                showResult('result', 'è¯·è¾“å…¥æ–‡ä»¶å', false);
                return;
            }

            showResult('result', 'æ­£åœ¨åˆ›å»ºæ–‡ä»¶ï¼Œè¯·ç¨å€™...', true);

            try {
                const response = await fetch('/file/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        server: server,
                        path: path,
                        filename: filename,
                        content: content
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult('result', `âœ… ${data.message}`, true);
                    // åˆ›å»ºæˆåŠŸååˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    listFiles();
                } else {
                    showResult('result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                showResult('result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        async function transferFolder() {
            const username = document.getElementById('transfer-username').value.trim();
            const projectname = document.getElementById('transfer-project').value.trim();
            const targetServer = document.getElementById('transfer-target').value;
            
            if (!username) {
                showResult('transfer-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            if (!projectname) {
                showResult('transfer-result', 'è¯·è¾“å…¥é¡¹ç›®åç§°', false);
                return;
            }
            
            showResult('transfer-result', 'ä¼ è¾“ä¸­ï¼Œè¯·ç¨å€™...', true);
            
            try {
                const response = await fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        projectname: projectname,
                        target_server: targetServer
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('transfer-result', `âœ… ${data.message}`, true);
                } else {
                    showResult('transfer-result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                showResult('transfer-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        // å¤šæ–‡ä»¶/ç›®å½•ä¼ è¾“
        async function transferMultiple() {
            const sourceServer = document.getElementById('multi-source-server').value;
            const sourcePathsText = document.getElementById('multi-source-paths').value.trim();
            const targetServer = document.getElementById('multi-target-server').value;
            const targetPath = document.getElementById('multi-target-path').value.trim();
            
            if (!sourcePathsText) {
                showResult('multi-transfer-result', 'è¯·è¾“å…¥æºè·¯å¾„åˆ—è¡¨', false);
                return;
            }
            
            if (!targetPath) {
                showResult('multi-transfer-result', 'è¯·è¾“å…¥ç›®æ ‡ç›®å½•è·¯å¾„', false);
                return;
            }
            
            // è§£ææºè·¯å¾„åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
            const sourcePaths = sourcePathsText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (sourcePaths.length === 0) {
                showResult('multi-transfer-result', 'æºè·¯å¾„åˆ—è¡¨ä¸èƒ½ä¸ºç©º', false);
                return;
            }
            
            showResult('multi-transfer-result', `ä¼ è¾“ä¸­ï¼Œå…± ${sourcePaths.length} ä¸ªæ–‡ä»¶/ç›®å½•...`, true);
            document.getElementById('multi-transfer-details').style.display = 'none';
            document.getElementById('multi-transfer-details').innerHTML = '';
            
            try {
                const response = await fetch('/transfer/multi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_server: sourceServer,
                        source_paths: sourcePaths,
                        target_server: targetServer,
                        target_path: targetPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('multi-transfer-result', `âœ… ${data.message}`, true);
                    displayMultiTransferDetails(data.details || []);
                } else {
                    showResult('multi-transfer-result', `âŒ ${data.error}`, false);
                    if (data.details && data.details.length > 0) {
                        displayMultiTransferDetails(data.details);
                    }
                }
            } catch (error) {
                showResult('multi-transfer-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function displayMultiTransferDetails(details) {
            const detailsDiv = document.getElementById('multi-transfer-details');
            detailsDiv.style.display = 'block';
            
            if (details.length === 0) {
                detailsDiv.innerHTML = '<div style="padding: 15px; background: #f8f9fa; border-radius: 5px; color: #666;">æš‚æ— è¯¦ç»†ä¿¡æ¯</div>';
                return;
            }
            
            let html = '<div style="margin-top: 15px;"><h3 style="margin-bottom: 10px; color: #667eea; font-size: 1.1em;">ä¼ è¾“è¯¦æƒ…:</h3>';
            html += '<div style="display: grid; gap: 10px;">';
            
            details.forEach((detail, index) => {
                const statusIcon = detail.success ? 'âœ…' : 'âŒ';
                const statusColor = detail.success ? '#28a745' : '#dc3545';
                const bgColor = detail.success ? '#d4edda' : '#f8d7da';
                
                html += `
                    <div style="padding: 15px; background: ${bgColor}; border-radius: 5px; border-left: 4px solid ${statusColor};">
                        <div style="font-weight: 600; margin-bottom: 8px;">
                            ${statusIcon} ${detail.type === 'directory' ? 'ğŸ“ ç›®å½•' : 'ğŸ“„ æ–‡ä»¶'} #${index + 1}
                        </div>
                        <div style="font-size: 13px; margin-bottom: 5px;">
                            <strong>æºè·¯å¾„:</strong> <span style="font-family: monospace; color: #333;">${detail.source}</span>
                        </div>
                        ${detail.target ? `
                            <div style="font-size: 13px; margin-bottom: 5px;">
                                <strong>ç›®æ ‡è·¯å¾„:</strong> <span style="font-family: monospace; color: #333;">${detail.target}</span>
                            </div>
                        ` : ''}
                        <div style="font-size: 13px; color: ${statusColor};">
                            <strong>çŠ¶æ€:</strong> ${detail.message}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            detailsDiv.innerHTML = html;
        }
        
        function clearMultiTransferResult() {
            document.getElementById('multi-transfer-result').style.display = 'none';
            document.getElementById('multi-transfer-details').style.display = 'none';
            document.getElementById('multi-transfer-details').innerHTML = '';
        }
        
        // è™šæ‹Ÿç¯å¢ƒç®¡ç†
        async function loadEnvs() {
            const username = document.getElementById('venv-username').value.trim();
            
            if (!username) {
                showResult('venv-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                document.getElementById('env-list').innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch('/env/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: username })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayEnvs(data.envs);
                    updateTerminalEnvSelect(data.envs);
                    showResult('venv-result', `æ‰¾åˆ° ${data.count} ä¸ªç¯å¢ƒ`, true);
                } else {
                    showResult('venv-result', `é”™è¯¯: ${data.error}`, false);
                    document.getElementById('env-list').innerHTML = '';
                }
            } catch (error) {
                showResult('venv-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function displayEnvs(envs) {
            const envListDiv = document.getElementById('env-list');
            
            if (envs.length === 0) {
                envListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— è™šæ‹Ÿç¯å¢ƒ</div>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            envs.forEach(env => {
                html += `
                    <div style="padding: 15px; background: white; border-radius: 5px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${env.name}</div>
                            <div style="font-size: 12px; color: #666; font-family: monospace;">${env.path}</div>
                        </div>
                        <button onclick="deleteEnv('${env.name}')" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                    </div>
                `;
            });
            html += '</div>';
            envListDiv.innerHTML = html;
        }
        
        function updateTerminalEnvSelect(envs) {
            const select = document.getElementById('terminal-env');
            // ä¿ç•™"ä¸ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ"é€‰é¡¹
            select.innerHTML = '<option value="">ä¸ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</option>';
            envs.forEach(env => {
                const option = document.createElement('option');
                option.value = env.name;
                option.textContent = env.name;
                select.appendChild(option);
            });
            
            // åŒæ—¶æ›´æ–°ç®—æ³•æ‰§è¡Œçš„ç¯å¢ƒé€‰æ‹©
            updateExecuteEnvSelect(envs);
        }
        
        function updateExecuteEnvSelect(envs) {
            const select = document.getElementById('execute-env');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è™šæ‹Ÿç¯å¢ƒ</option>';
            envs.forEach(env => {
                const option = document.createElement('option');
                option.value = env.name;
                option.textContent = env.name;
                select.appendChild(option);
            });
        }
        
        async function createEnv() {
            const envName = document.getElementById('new-env-name').value.trim();
            const username = document.getElementById('venv-username').value.trim();
            
            if (!username) {
                showResult('venv-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            if (!envName) {
                showResult('venv-result', 'è¯·è¾“å…¥ç¯å¢ƒåç§°', false);
                return;
            }
            
            showResult('venv-result', 'åˆ›å»ºä¸­ï¼Œè¯·ç¨å€™...', true);
            
            try {
                const response = await fetch('/env/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        env_name: envName,
                        username: username
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('venv-result', `âœ… ${data.message}`, true);
                    document.getElementById('new-env-name').value = '';
                    loadEnvs(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showResult('venv-result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                showResult('venv-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        async function deleteEnv(envName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¯å¢ƒ "${envName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            const username = document.getElementById('venv-username').value.trim();
            
            if (!username) {
                showResult('venv-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            try {
                const response = await fetch('/env/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        env_name: envName,
                        username: username
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('venv-result', `âœ… ${data.message}`, true);
                    loadEnvs(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showResult('venv-result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                showResult('venv-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        // ç½‘é¡µç»ˆç«¯
        async function executeCommand() {
            const command = document.getElementById('terminal-command').value.trim();
            const envName = document.getElementById('terminal-env').value;
            const username = document.getElementById('venv-username').value.trim();
            
            if (!username) {
                appendTerminalOutput('é”™è¯¯: è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (!command) {
                appendTerminalOutput('è¯·è¾“å…¥å‘½ä»¤', 'error');
                return;
            }
            
            appendTerminalOutput(`$ ${command}${envName ? ` [ç¯å¢ƒ: ${envName}]` : ''}`, 'command');
            
            try {
                const response = await fetch('/env/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        command: command,
                        env_name: envName || null,
                        username: username
                    })
                });
                
                const data = await response.json();
                
                if (data.stdout) {
                    appendTerminalOutput(data.stdout, 'stdout');
                }
                if (data.stderr) {
                    appendTerminalOutput(data.stderr, 'stderr');
                }
                if (!data.success && !data.stdout && !data.stderr) {
                    appendTerminalOutput(`é”™è¯¯: ${data.error || 'å‘½ä»¤æ‰§è¡Œå¤±è´¥'}`, 'error');
                }
            } catch (error) {
                appendTerminalOutput(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('terminal-command').value = '';
        }
        
        function appendTerminalOutput(text, type) {
            const outputDiv = document.getElementById('terminal-output');
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            let prefix = '';
            
            switch(type) {
                case 'command':
                    className = 'color: #4ec9b0;';
                    prefix = `[${timestamp}] `;
                    break;
                case 'stdout':
                    className = 'color: #d4d4d4;';
                    break;
                case 'stderr':
                    className = 'color: #f48771;';
                    break;
                case 'error':
                    className = 'color: #f48771;';
                    prefix = '[é”™è¯¯] ';
                    break;
            }
            
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦
            const escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>').replace(/\r/g, '');
            outputDiv.innerHTML += `<div style="${className}">${prefix}${escapedText}</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function clearTerminal() {
            document.getElementById('terminal-output').innerHTML = '';
        }
        
        // ç®—æ³•æ‰§è¡ŒåŠŸèƒ½
        async function loadProjects() {
            const username = document.getElementById('execute-username').value.trim();
            // é¡¹ç›®åˆ—è¡¨å›ºå®šä» server101 æŸ¥è¯¢ï¼ˆé¡¹ç›®ä»£ç æºæœåŠ¡å™¨ï¼‰
            const server = 'server101';
            
            if (!username) {
                showResult('execute-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                document.getElementById('execute-project').innerHTML = '<option value="">è¯·å…ˆè¾“å…¥ç”¨æˆ·åå¹¶åˆ·æ–°</option>';
                return;
            }
            
            try {
                const response = await fetch('/project/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        server: server  // å›ºå®šä½¿ç”¨ server101
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateProjectSelect(data.projects);
                    showResult('execute-result', `æ‰¾åˆ° ${data.count} ä¸ªé¡¹ç›®`, true);
                } else {
                    showResult('execute-result', `é”™è¯¯: ${data.error}`, false);
                    document.getElementById('execute-project').innerHTML = '<option value="">æ— é¡¹ç›®</option>';
                }
            } catch (error) {
                showResult('execute-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function updateProjectSelect(projects) {
            const select = document.getElementById('execute-project');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡¹ç›®</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.name;
                option.textContent = `${project.name}${project.has_requirements ? ' âœ“' : ''}`;
                select.appendChild(option);
            });
        }
        
        let eventSource = null;
        let currentLogFile = null;
        
        async function executeProject() {
            const username = document.getElementById('execute-username').value.trim();
            const projectname = document.getElementById('execute-project').value;
            const envName = document.getElementById('execute-env').value;
            const command = document.getElementById('execute-command').value.trim();
            const server = document.getElementById('execute-server').value;
            
            if (!username) {
                showResult('execute-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            if (!projectname) {
                showResult('execute-result', 'è¯·é€‰æ‹©é¡¹ç›®', false);
                return;
            }
            
            if (!envName) {
                showResult('execute-result', 'è¯·é€‰æ‹©è™šæ‹Ÿç¯å¢ƒï¼ˆå¿…éœ€ï¼‰', false);
                return;
            }
            
            if (!command) {
                showResult('execute-result', 'è¯·è¾“å…¥æ‰§è¡Œå‘½ä»¤', false);
                return;
            }
            
            // åœæ­¢ä¹‹å‰çš„è½®è¯¢
            if (window.executePollInterval) {
                clearInterval(window.executePollInterval);
                window.executePollInterval = null;
            }
            
            const outputDiv = document.getElementById('execute-output');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
            appendExecuteOutput(`[${new Date().toLocaleTimeString()}] å¼€å§‹æ‰§è¡Œç®—æ³•...`, 'info');
            appendExecuteOutput(`é¡¹ç›®: ${projectname} | ç¯å¢ƒ: ${envName} | å‘½ä»¤: ${command}`, 'info');
            showResult('execute-result', 'æ‰§è¡Œä¸­ï¼Œå®æ—¶æ—¥å¿—è¾“å‡º...', true);
            
            // å¯åŠ¨æ‰§è¡Œå¹¶å¼€å§‹è½®è¯¢æ—¥å¿—
            let logFile = null;
            let lastLength = 0;
            let pollCount = 0;
            const maxPollCount = 3600; // æœ€å¤šè½®è¯¢1å°æ—¶ï¼ˆ3600æ¬¡ * 1ç§’ï¼‰
            
            fetch('/project/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    projectname: projectname,
                    env_name: envName,
                    command: command,
                    server: server
                })
            }).then(response => response.json())
            .then(data => {
                if (data.log_file) {
                    logFile = data.log_file;
                    currentLogFile = logFile;
                    appendExecuteOutput(`æ—¥å¿—æ–‡ä»¶: ${data.log_file}`, 'info');
                    
                    // å¼€å§‹è½®è¯¢logæ–‡ä»¶ï¼ˆå®æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼‰
                    window.executePollInterval = setInterval(async () => {
                        pollCount++;
                        if (pollCount > maxPollCount) {
                            clearInterval(window.executePollInterval);
                            appendExecuteOutput('è½®è¯¢è¶…æ—¶ï¼Œåœæ­¢å®æ—¶æ—¥å¿—', 'error');
                            return;
                        }
                        
                        try {
                            const logResponse = await fetch('/project/log', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    username: username,
                                    projectname: projectname,
                                    log_file: logFile
                                })
                            });
                            
                            const logData = await logResponse.json();
                            if (logData.success && logData.content) {
                                const content = logData.content;
                                if (content.length > lastLength) {
                                    const newContent = content.substring(lastLength);
                                    const lines = newContent.split('\n');
                                    lines.forEach(line => {
                                        if (line.trim()) {
                                            appendExecuteOutput(line, 'stdout');
                                        }
                                    });
                                    lastLength = content.length;
                                }
                            }
                        } catch (error) {
                            console.error('è½®è¯¢æ—¥å¿—å¤±è´¥:', error);
                        }
                    }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
                    
                    // æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼ˆå»¶è¿Ÿæ£€æŸ¥ï¼‰
                    setTimeout(() => {
                        // å†æ¬¡è·å–æœ€ç»ˆæ—¥å¿—
                        fetch('/project/log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                username: username,
                                projectname: projectname,
                                log_file: logFile
                            })
                        }).then(response => response.json())
                        .then(logData => {
                            if (window.executePollInterval) {
                                clearInterval(window.executePollInterval);
                                window.executePollInterval = null;
                            }
                            
                            if (data.success) {
                                appendExecuteOutput(`[${new Date().toLocaleTimeString()}] âœ… æ‰§è¡Œå®Œæˆ`, 'success');
                                appendExecuteOutput(`æ—¥å¿—å·²ä¿å­˜åˆ°: ${data.log_file}`, 'info');
                                showResult('execute-result', 'âœ… ç®—æ³•æ‰§è¡Œå®Œæˆ', true);
                            } else {
                                appendExecuteOutput(`[é”™è¯¯] ${data.error || 'æ‰§è¡Œå¤±è´¥'}`, 'error');
                                if (data.log_file) {
                                    appendExecuteOutput(`æ—¥å¿—å·²ä¿å­˜åˆ°: ${data.log_file}`, 'info');
                                }
                                showResult('execute-result', `âŒ ${data.error || 'æ‰§è¡Œå¤±è´¥'}`, false);
                            }
                        });
                    }, 3000); // 3ç§’åæ£€æŸ¥æœ€ç»ˆç»“æœ
                } else {
                    // æ²¡æœ‰logæ–‡ä»¶ï¼Œä½¿ç”¨æ™®é€šè¾“å‡º
                    executeProjectNormal(username, projectname, envName, command, server, data);
                }
            }).catch(error => {
                appendExecuteOutput(`æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                showResult('execute-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            });
        }
        
        // æ™®é€šæ‰§è¡Œæ¨¡å¼ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        async function executeProjectNormal(username, projectname, envName, command, server) {
            try {
                const response = await fetch('/project/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        projectname: projectname,
                        env_name: envName,
                        command: command,
                        server: server
                    })
                });
                
                const data = await response.json();
                
                if (data.stdout) {
                    appendExecuteOutput(data.stdout, 'stdout');
                }
                if (data.stderr) {
                    appendExecuteOutput(data.stderr, 'stderr');
                }
                
                if (data.success) {
                    showResult('execute-result', 'âœ… ç®—æ³•æ‰§è¡Œå®Œæˆ', true);
                    if (data.log_file) {
                        appendExecuteOutput(`æ—¥å¿—å·²ä¿å­˜åˆ°: ${data.log_file}`, 'info');
                    }
                } else {
                    showResult('execute-result', `âŒ æ‰§è¡Œå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, false);
                    if (data.error) {
                        appendExecuteOutput(`é”™è¯¯: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                showResult('execute-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
                appendExecuteOutput(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function appendExecuteOutput(text, type) {
            const outputDiv = document.getElementById('execute-output');
            const timestamp = new Date().toLocaleTimeString();
            let className = '';
            let prefix = '';
            
            switch(type) {
                case 'info':
                    className = 'color: #4ec9b0;';
                    prefix = `[${timestamp}] `;
                    break;
                case 'stdout':
                    className = 'color: #d4d4d4;';
                    break;
                case 'stderr':
                    className = 'color: #f48771;';
                    break;
                case 'error':
                    className = 'color: #f48771;';
                    prefix = '[é”™è¯¯] ';
                    break;
                case 'success':
                    className = 'color: #4ec9b0; font-weight: bold;';
                    prefix = `[${timestamp}] `;
                    break;
            }
            
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦
            const escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>').replace(/\r/g, '');
            outputDiv.innerHTML += `<div style="${className}">${prefix}${escapedText}</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function clearExecuteOutput() {
            document.getElementById('execute-output').innerHTML = '';
            document.getElementById('execute-output').style.display = 'none';
        }
        
        // åå°æ‰§è¡Œç®—æ³•ï¼ˆè¿”å›è¿›ç¨‹IDï¼‰
        async function executeProjectBackground() {
            const username = document.getElementById('execute-username').value.trim();
            const projectname = document.getElementById('execute-project').value;
            const envName = document.getElementById('execute-env').value;
            const command = document.getElementById('execute-command').value.trim();
            
            if (!username) {
                showResult('execute-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            if (!projectname) {
                showResult('execute-result', 'è¯·é€‰æ‹©é¡¹ç›®', false);
                return;
            }
            
            if (!envName) {
                showResult('execute-result', 'è¯·é€‰æ‹©è™šæ‹Ÿç¯å¢ƒï¼ˆå¿…éœ€ï¼‰', false);
                return;
            }
            
            if (!command) {
                showResult('execute-result', 'è¯·è¾“å…¥æ‰§è¡Œå‘½ä»¤', false);
                return;
            }
            
            showResult('execute-result', 'æ­£åœ¨å¯åŠ¨åå°è¿›ç¨‹...', true);
            
            const outputDiv = document.getElementById('execute-output');
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '';
            appendExecuteOutput(`[${new Date().toLocaleTimeString()}] æ­£åœ¨å¯åŠ¨åå°è¿›ç¨‹...`, 'info');
            appendExecuteOutput(`é¡¹ç›®: ${projectname} | ç¯å¢ƒ: ${envName} | å‘½ä»¤: ${command}`, 'info');
            
            try {
                const response = await fetch('/project/execute/background', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        projectname: projectname,
                        env_name: envName,
                        command: command
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    appendExecuteOutput(`[${new Date().toLocaleTimeString()}] âœ… åå°è¿›ç¨‹å·²å¯åŠ¨`, 'success');
                    appendExecuteOutput(`è¿›ç¨‹ID (PID): ${data.pid}`, 'info');
                    appendExecuteOutput(`æ—¥å¿—æ–‡ä»¶: ${data.log_file}`, 'info');
                    appendExecuteOutput(`é¡¹ç›®è·¯å¾„: ${data.project_path}`, 'info');
                    appendExecuteOutput(`ç¯å¢ƒè·¯å¾„: ${data.env_path}`, 'info');
                    appendExecuteOutput('', 'info');
                    appendExecuteOutput('æç¤ºï¼šè¿›ç¨‹å·²åœ¨åå°è¿è¡Œï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹IDç®¡ç†è¯¥è¿›ç¨‹', 'info');
                    appendExecuteOutput('æ—¥å¿—è¾“å‡ºå·²ä¿å­˜åˆ°ä¸Šè¿°æ—¥å¿—æ–‡ä»¶ä¸­', 'info');
                    
                    showResult('execute-result', `âœ… åå°è¿›ç¨‹å·²å¯åŠ¨ï¼Œè¿›ç¨‹ID: ${data.pid}`, true);
                } else {
                    appendExecuteOutput(`[${new Date().toLocaleTimeString()}] âŒ å¯åŠ¨å¤±è´¥`, 'error');
                    appendExecuteOutput(`é”™è¯¯: ${data.error}`, 'error');
                    showResult('execute-result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                appendExecuteOutput(`[${new Date().toLocaleTimeString()}] âŒ è¯·æ±‚å¤±è´¥`, 'error');
                appendExecuteOutput(`é”™è¯¯: ${error.message}`, 'error');
                showResult('execute-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        // å½“ç¯å¢ƒåˆ—è¡¨æ›´æ–°æ—¶ï¼ŒåŒæ­¥æ›´æ–°ç®—æ³•æ‰§è¡Œçš„ç¯å¢ƒé€‰æ‹©
        function updateExecuteEnvSelect(envs) {
            const select = document.getElementById('execute-env');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è™šæ‹Ÿç¯å¢ƒ</option>';
            envs.forEach(env => {
                const option = document.createElement('option');
                option.value = env.name;
                option.textContent = env.name;
                select.appendChild(option);
            });
        }
        
        // ä»»åŠ¡æ£€æŸ¥ä¸å¤åˆ¶
        async function checkTaskAndCopy() {
            const username = document.getElementById('task-username').value.trim();
            const pid = document.getElementById('task-pid').value.trim();
            const projectname = document.getElementById('task-projectname').value.trim();
            const taskid = document.getElementById('task-taskid').value.trim();
            const logFile = document.getElementById('task-log-file').value.trim();
            
            if (!username) {
                showResult('task-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }
            
            if (!pid) {
                showResult('task-result', 'è¯·è¾“å…¥è¿›ç¨‹ID', false);
                return;
            }
            
            if (!projectname) {
                showResult('task-result', 'è¯·è¾“å…¥ç®—æ³•é¡¹ç›®å', false);
                return;
            }
            
            if (!taskid) {
                showResult('task-result', 'è¯·è¾“å…¥ä»»åŠ¡ID', false);
                return;
            }
            
            showResult('task-result', 'æ­£åœ¨æ£€æŸ¥è¿›ç¨‹çŠ¶æ€ï¼Œè¯·ç¨å€™...', true);
            
            try {
                const requestBody = {
                    pid: pid,
                    username: username,
                    projectname: projectname,
                    taskid: taskid
                };
                
                // å¦‚æœæä¾›äº†æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (logFile) {
                    requestBody.log_file = logFile;
                }
                
                const response = await fetch('/task/check_and_copy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = '';
                    if (data.status === 'running') {
                        message = `âœ… è¿›ç¨‹çŠ¶æ€: è¿è¡Œä¸­\n` +
                                 `è¿›ç¨‹ID: ${data.pid}\n` +
                                 `ç”¨æˆ·å: ${data.username}\n` +
                                 `é¡¹ç›®å: ${data.projectname}\n` +
                                 `ä»»åŠ¡ID: ${data.taskid}\n` +
                                 `\n${data.message}`;
                    } else if (data.status === 'completed') {
                        message = `âœ… è¿›ç¨‹çŠ¶æ€: å·²å®Œæˆ\n` +
                                 `è¿›ç¨‹ID: ${data.pid}\n` +
                                 `ç”¨æˆ·å: ${data.username}\n` +
                                 `é¡¹ç›®å: ${data.projectname}\n` +
                                 `ä»»åŠ¡ID: ${data.taskid}\n` +
                                 `è¾“å‡ºè·¯å¾„: ${data.output_path || 'N/A'}\n`;
                        
                        if (data.dir_exists) {
                            message += `\nç›®å½•å·²å­˜åœ¨ï¼Œæ— éœ€å¤åˆ¶`;
                        } else {
                            message += `\næºè·¯å¾„: ${data.source_path || 'N/A'}\n` +
                                      `ç›®æ ‡è·¯å¾„: ${data.output_path || 'N/A'}\n` +
                                      `\n${data.message || 'å¤åˆ¶å®Œæˆ'}`;
                            if (data.copy_message) {
                                message += `\n\n${data.copy_message}`;
                            }
                            // æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶å¤åˆ¶ä¿¡æ¯
                            if (data.log_file_copied) {
                                message += `\n\nå·²å¤åˆ¶æ—¥å¿—æ–‡ä»¶:\n`;
                                message += `æ–‡ä»¶å: ${data.log_file_copied.filename}\n`;
                                message += `æºè·¯å¾„: ${data.log_file_copied.source}\n`;
                                message += `ç›®æ ‡è·¯å¾„: ${data.log_file_copied.target}\n`;
                            } else {
                                message += `\n\næœªæ‰¾åˆ°æˆ–æœªå¤åˆ¶æ—¥å¿—æ–‡ä»¶`;
                            }
                        }
                    }
                    showResult('task-result', message, true);
                } else {
                    let errorMsg = `âŒ é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}\n`;
                    if (data.status) {
                        errorMsg += `è¿›ç¨‹çŠ¶æ€: ${data.status}\n`;
                    }
                    if (data.pid) {
                        errorMsg += `è¿›ç¨‹ID: ${data.pid}\n`;
                    }
                    if (data.output_path) {
                        errorMsg += `è¾“å‡ºè·¯å¾„: ${data.output_path}\n`;
                    }
                    showResult('task-result', errorMsg, false);
                }
            } catch (error) {
                showResult('task-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function clearTaskResult() {
            document.getElementById('task-result').style.display = 'none';
            document.getElementById('task-result').innerHTML = '';
        }
        
        // æ–‡ä»¶å†…å®¹è¯»å–
        async function readFileContent() {
            const server = document.getElementById('read-server').value;
            const filePath = document.getElementById('read-file-path').value.trim();
            
            if (!filePath) {
                showResult('read-file-result', 'è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„', false);
                return;
            }
            
            showResult('read-file-result', 'æ­£åœ¨è¯»å–æ–‡ä»¶ï¼Œè¯·ç¨å€™...', true);
            document.getElementById('file-content-display').style.display = 'none';
            
            try {
                const response = await fetch('/file/read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        server: server,
                        path: filePath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('read-file-result', `âœ… æ–‡ä»¶è¯»å–æˆåŠŸ: ${data.path}`, true);
                    const contentDiv = document.getElementById('file-content-display');
                    contentDiv.style.display = 'block';
                    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
                    const escapedContent = data.content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    contentDiv.innerHTML = escapedContent;
                } else {
                    showResult('read-file-result', `âŒ ${data.error}`, false);
                }
            } catch (error) {
                showResult('read-file-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
        
        function clearFileContent() {
            document.getElementById('read-file-result').style.display = 'none';
            document.getElementById('file-content-display').style.display = 'none';
            document.getElementById('file-content-display').innerHTML = '';
        }
        
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢å½“å‰æœåŠ¡å™¨å’Œç¯å¢ƒåˆ—è¡¨
        window.onload = function() {
            listFiles();
            loadEnvs();
        };

        // ç”¨æˆ·åˆå§‹åŒ–ï¼šåœ¨å››å°æœåŠ¡å™¨ä¸Šåˆ›å»ºåŸºç¡€ç›®å½•
        async function createUserOnAllServers() {
            const username = document.getElementById('init-username').value.trim();
            if (!username) {
                showResult('init-user-result', 'è¯·è¾“å…¥ç”¨æˆ·å', false);
                return;
            }

            showResult('init-user-result', 'æ­£åœ¨åˆ›å»ºç”¨æˆ·ç›®å½•ï¼Œè¯·ç¨å€™...', true);

            try {
                const response = await fetch('/user/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    const details = data.details || {};
                    const lines = [
                        `âœ… ç”¨æˆ· ${data.username} ç›®å½•åˆ›å»ºå®Œæˆï¼š`,
                        `- server101: ${details.server101 || 'æœªçŸ¥'}`,
                        `- server102: ${details.server102 || 'æœªçŸ¥'}`,
                        `- server103: ${details.server103 || 'æœªçŸ¥'}`,
                        `- server104: ${details.server104 || 'æœªçŸ¥'}`
                    ];
                    showResult('init-user-result', lines.join('\n'), true);
                } else {
                    const details = data.details || {};
                    const lines = [
                        `âŒ åˆ›å»ºç”¨æˆ·ç›®å½•æ—¶å‘ç”Ÿé”™è¯¯ï¼š${data.message || data.error || 'æœªçŸ¥é”™è¯¯'}`,
                        `- server101: ${details.server101 || 'æœªçŸ¥'}`,
                        `- server102: ${details.server102 || 'æœªçŸ¥'}`,
                        `- server103: ${details.server103 || 'æœªçŸ¥'}`,
                        `- server104: ${details.server104 || 'æœªçŸ¥'}`
                    ];
                    showResult('init-user-result', lines.join('\n'), false);
                }
            } catch (error) {
                showResult('init-user-result', `è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            }
        }
    </script>
</body>
</html>

