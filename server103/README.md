# Server103 Flask åº”ç”¨

## éƒ¨ç½²è¯´æ˜

1. **åœ¨ 10.3 æœåŠ¡å™¨ä¸Šå‡†å¤‡ç¯å¢ƒ**
   - å°†æœ¬é¡¹ç›®ä¸Šä¼ åˆ° 10.3 æœåŠ¡å™¨ä»»æ„ç›®å½•ï¼›
   - `cd` åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼›
   - æ‰§è¡Œï¼š`python3 -m venv venv` åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚

2. **åœ¨ 10.3 æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¹¶å¯åŠ¨ server103 æœåŠ¡**
   - å°†æœ¬é¡¹ç›®æ”¾ç½®åœ¨ 10.3 æœåŠ¡å™¨çš„ `/home/user/common/server103` ç›®å½•ä¸‹ï¼ˆä¸å®é™…éƒ¨ç½²è·¯å¾„ä¿æŒä¸€è‡´ï¼‰ï¼›
   - `cd` åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼›
   - æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š  
     `nohup bash ./start.sh > start.log 2>&1 &`

## åŠŸèƒ½è¯´æ˜

`server103` æ˜¯ä¸€ä¸ªåŸºäº Flask å’Œ Paramiko çš„**ç®—æ³•è°ƒåº¦ä¸ç®¡ç†æœåŠ¡**ï¼Œä¸»è¦èƒ½åŠ›åŒ…æ‹¬ï¼š

- åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“é¡¹ç›®ä»£ç /è¾“å‡ºï¼ˆä¸ `server101`/`server102`/`server104` ååŒï¼‰ï¼›
- åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šåˆ—ç›®å½•ã€åˆ›å»ºæ–‡ä»¶ï¼›
- åœ¨ `server102` ä¸Š**åˆ›å»º / åˆ—å‡º / åˆ é™¤è™šæ‹Ÿç¯å¢ƒ**ï¼›
- åœ¨æŒ‡å®šè™šæ‹Ÿç¯å¢ƒå’Œé¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œç®—æ³•ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥ï¼‰ï¼›
- å°†æ‰§è¡Œæ—¥å¿—ä¸å®Œæ•´é¡¹ç›®è¾“å‡ºç»Ÿä¸€å½’æ¡£åˆ° `server104` ä¸Šã€‚

å½“å‰æœåŠ¡æ ‡è¯†ä¸º `server103`ï¼Œç›‘å¬ç«¯å£ä¸º `5003`ï¼Œå¹¶æä¾›ä¸€ä¸ªç®€å•çš„æµ‹è¯•é¡µé¢ `/test`ï¼ˆå¯¹åº” `templates/test.html`ï¼‰ã€‚

## å®‰è£…ä¾èµ–

ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `requirements.txt` å®‰è£…ä¾èµ–ï¼ˆæ¨èä½¿ç”¨æœ¬åœ° pypiserver æºï¼‰ï¼š

```bash
pip install -r requirements.txt --index-url http://192.168.10.2:8087/simple/ --trusted-host 192.168.10.2
```

## è¿è¡ŒæœåŠ¡

ç›´æ¥è¿è¡Œï¼ˆå¼€å‘/è°ƒè¯•ï¼‰ï¼š

```bash
python3 app.py
```

æœåŠ¡å°†åœ¨ `http://0.0.0.0:5003` å¯åŠ¨ã€‚

é€šè¿‡è„šæœ¬è¿è¡Œï¼ˆæ¨èçº¿ä¸Šä½¿ç”¨ï¼‰ï¼š

```bash
./start.sh
```

## ä¸»è¦ API ä¸€è§ˆ

> è¿™é‡Œåªåˆ—å‡ºä¸»çº¿èƒ½åŠ›çš„æ¥å£ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥é˜…ï¼›è¯¦ç»†å‚æ•°è¯·å‚ç…§ä»£ç æ³¨é‡Šæˆ–æŒ‰éœ€è¡¥å……æ–‡æ¡£ã€‚

- **å¥åº·æ£€æŸ¥**ï¼š`GET /health`  
  è¿”å›å½“å‰æœåŠ¡çŠ¶æ€ä¸æœåŠ¡å™¨æ ‡è¯†ã€‚  

- **ç”¨æˆ·åˆå§‹åŒ–ï¼ˆåœ¨å››å°æœåŠ¡å™¨åˆ›å»ºç”¨æˆ·ç›®å½•ï¼‰**ï¼š`POST /user/create`  
  - å…¥å‚ç¤ºä¾‹ï¼š
    ```json
    {
      "username": "gousk"
    }
    ```
  - æ•ˆæœï¼šåœ¨ 10.1 / 10.2 / 10.3 / 10.4 ä¸Šåˆ†åˆ«åˆ›å»ºï¼š  
    - `10.1`ï¼š`/home/user/{username}`ã€`/home/user/{username}/projects`  
    - `10.2`ï¼š`/home/user/{username}`ã€`/home/user/{username}/projects`ã€`/home/user/{username}/envs`  
    - `10.3`ï¼š`/home/user/{username}`ã€`/home/user/{username}/projects`  
    - `10.4`ï¼š`/home/user/{username}`ã€`/home/user/{username}/outputs`  
  - å¯¹åº” Web é¡µé¢ä¸Šçš„â€œğŸ‘¤ ç”¨æˆ·åˆå§‹åŒ–ï¼ˆåœ¨å››å°æœåŠ¡å™¨åˆ›å»ºç›®å½•ï¼‰â€åŠŸèƒ½åŒºã€‚  

- **é¡¹ç›®ä¼ è¾“ï¼ˆæœ¬åœ°â†’å…¶ä»–æœåŠ¡å™¨ï¼‰**ï¼š`POST /transfer`  
  - æ ¹æ® `username` + `projectname` ç»„åˆè·¯å¾„ï¼š  
    - æºè·¯å¾„ï¼š`/home/user/{username}/projects/{projectname}`ï¼ˆåœ¨ server103 æ‰€åœ¨æœºå™¨ä¸Šï¼‰ï¼›  
    - ç›®æ ‡è·¯å¾„ï¼š  
      - `server101`/`server102`ï¼š`/home/user/{username}/projects/{projectname}`ï¼›  
      - `server104`ï¼š`/home/user/{username}/outputs/{projectname}`ã€‚  

- **è¿œç¨‹ç›®å½•æ–‡ä»¶åˆ—è¡¨**ï¼š`POST /list`  
  - è¯·æ±‚ç¤ºä¾‹ï¼š
    ```json
    {
      "server": "server101",
      "path": "/home/user"
    }
    ```
  - ç”¨äºæµè§ˆè¿œç¨‹æœåŠ¡å™¨æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å’Œå­ç›®å½•ã€‚  

- **è¿œç¨‹åˆ›å»ºæ–‡ä»¶**ï¼š`POST /file/create`  
  - å¯åœ¨æŒ‡å®šæœåŠ¡å™¨ + ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚  

- **è™šæ‹Ÿç¯å¢ƒç®¡ç†ï¼ˆå‡ä½œç”¨äº server102ï¼‰**ï¼š  
  - åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼š`POST /env/create`  
  - åˆ—å‡ºè™šæ‹Ÿç¯å¢ƒï¼š`POST /env/list`  
  - åˆ é™¤è™šæ‹Ÿç¯å¢ƒï¼š`POST /env/delete`  

- **è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆç±» Web Terminalï¼‰**ï¼š`POST /env/execute`  
  - å¯é€‰æ‹©æ˜¯å¦å…ˆæ¿€æ´»æŒ‡å®šè™šæ‹Ÿç¯å¢ƒï¼Œå†æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚  

- **é¡¹ç›®æ‰§è¡Œï¼ˆåŒæ­¥ï¼‰**ï¼š`POST /project/execute`  
  - åœ¨æŒ‡å®šè™šæ‹Ÿç¯å¢ƒã€æŒ‡å®šé¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œç®—æ³•ï¼›  
  - æ”¯æŒåœ¨è¿è¡Œå‰è‡ªåŠ¨å®‰è£… `requirements.txt` ä¸­çš„ä¾èµ–ï¼›  
  - æ—¥å¿—ä¸é¡¹ç›®è¾“å‡ºä¼šåŒæ­¥å½’æ¡£åˆ° `server104:/home/user/{username}/outputs/{projectname}`ã€‚  

- **é¡¹ç›®æ‰§è¡Œï¼ˆå¼‚æ­¥ï¼‰**ï¼š`POST /project/execute/async`  
  - åå°æ‰§è¡Œç®—æ³•ï¼Œæ¥å£ç«‹å³è¿”å›ï¼Œæ—¥å¿—å†™å…¥ `server104`ï¼›  
  - ä¼šä¸ºæ¯æ¬¡è¿è¡Œåˆ›å»ºç‹¬ç«‹çš„å­ç›®å½•ï¼ˆæŒ‰ run_xxx å‘½åï¼‰ã€‚  

- **é¡¹ç›®åˆ—è¡¨**ï¼š`POST /project/list`  
  - åˆ—å‡ºæŸä¸ªæœåŠ¡å™¨ä¸Š `/home/user/{username}/projects` ä¸‹çš„é¡¹ç›®ã€‚  

- **é¡¹ç›®æ—¥å¿—è·å–**ï¼š`POST /project/log`  
  - ä» `server104:/home/user/{username}/outputs/{projectname}` ä¸­è¯»å–æœ€è¿‘ä¸€æ¬¡æˆ–æŒ‡å®š log æ–‡ä»¶å†…å®¹ã€‚  

## ä½¿ç”¨ç¤ºä¾‹ï¼ˆèŠ‚é€‰ï¼‰

### å¥åº·æ£€æŸ¥

```bash
curl http://localhost:5003/health
```

### ç”¨æˆ·åˆå§‹åŒ–

```bash
curl -X POST http://localhost:5003/user/create \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1"
  }'
```

### è§¦å‘ä¸€æ¬¡åŒæ­¥é¡¹ç›®æ‰§è¡Œ

```bash
curl -X POST http://localhost:5003/project/execute \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "projectname": "myproject",
    "env_name": "myenv",
    "command": "python main.py",
    "server": "server102"
  }'
```

### è·å–æœ€æ–°æ‰§è¡Œæ—¥å¿—

```bash
curl -X POST http://localhost:5003/project/log \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "projectname": "myproject"
  }'
```

## æ³¨æ„äº‹é¡¹

1. **SSH è´¦å· / å¯†ç **ï¼š`SERVER_CONFIG` ä¸­é»˜è®¤ä½¿ç”¨ `user/1234567`ï¼Œå¦‚æœçº¿ä¸Šç¯å¢ƒæœ‰å˜æ›´ï¼Œè¯·åŠ¡å¿…åŒæ­¥ä¿®æ”¹ã€‚  
2. **ç›®å½•çº¦å®š**ï¼š
   - é¡¹ç›®ä»£ç ç»Ÿä¸€æ”¾åœ¨ï¼š`/home/user/{username}/projects/{projectname}`ï¼›
   - è¾“å‡ºä¸æ—¥å¿—ç»Ÿä¸€æ”¾åœ¨ï¼š`server104:/home/user/{username}/outputs/{projectname}`ã€‚  
3. **ç½‘ç»œä¸æƒé™**ï¼šç¡®ä¿å››å°æœåŠ¡å™¨ä¹‹é—´ SSH è”é€šã€è´¦å·æœ‰è¶³å¤Ÿæ–‡ä»¶/ç›®å½•è¯»å†™æƒé™ã€‚  
4. **å®‰å…¨æ€§**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ç”¨å¯†é’¥è®¤è¯ï¼Œå¹¶é¿å…æ˜æ–‡å¯†ç ç›´æ¥å†™åœ¨ä»£ç ä¸­ã€‚  


